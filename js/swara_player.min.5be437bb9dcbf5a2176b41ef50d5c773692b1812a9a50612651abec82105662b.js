const TAMIL_MAP={"ச":"S","ரி":"R2","ர":"R2","க":"G3","ம":"M1","ப":"P","த":"D2","நி":"N3"};let audioCtx,masterGain,activePlayers={};const ST={S:0,R1:1,R2:2,G1:2,R3:3,G2:3,G3:4,M1:5,M2:6,P:7,D1:8,D2:9,N1:9,D3:10,N2:10,N3:11};function getAudio(){return audioCtx||(audioCtx=new(window.AudioContext||window.webkitAudioContext),masterGain=audioCtx.createGain(),masterGain.gain.value=1.5,masterGain.connect(audioCtx.destination)),audioCtx}function midiToFreq(e){return 440*2**((e-69)/12)}function swaraFreq(e,t){const n=ST[e];return n===0[0]?null:midiToFreq(60+n+t*12)}function playTone(e,t,n=.5){const o=getAudio(),s=o.createGain();s.connect(masterGain);const a=[{ratio:1,gain:1},{ratio:2,gain:.4},{ratio:3,gain:.25},{ratio:4,gain:.15},{ratio:5,gain:.08}],i=[];return a.forEach(a=>{const r=o.createOscillator(),c=o.createGain();r.type="sine",r.frequency.value=e*a.ratio,c.gain.value=a.gain,r.connect(c),c.connect(s),r.start(t),r.stop(t+n+.3),i.push(...r)}),s.gain.setValueAtTime(0,t),s.gain.linearRampToValueAtTime(1.2,t+.01),s.gain.exponentialRampToValueAtTime(.5,t+.15),s.gain.exponentialRampToValueAtTime(.001,t+n+.3),i}window.toggleSwaraPlay=function(e){const n=e.closest(".swara-block"),t=n.dataset.playerId||String(Date.now());if(n.dataset.playerId=t,Object.keys(activePlayers).forEach(e=>{e!==t&&stopPlayer(e,document.querySelector(`[data-player-id="${e}"] .swara-play-btn`))}),activePlayers[t]){stopPlayer(t,e);return}const s=getAudio();s.state==="suspended"&&s.resume(),startPlayer(n,e,t)};function startFromIndex(e,t,n,s){activePlayers[n]&&stopPlayer(n,t);const o=Array.from(e.querySelectorAll(".swara-cell"));if(!o.length)return;const l=parseInt(e.dataset.bpm)||72,i=60/l,d=parseInt(e.dataset.octave)||4,a=getAudio();a.state==="suspended"&&a.resume();const u=a.currentTime+.05,r=[],c=[];for(let n=s;n<o.length;n++){const e=o[n],m=e.innerText.trim(),a=TAMIL_MAP[m];if(!a)continue;let t=d-4;e.classList.contains("mandra")&&(t-=1),e.classList.contains("anumandra")&&(t-=2),e.classList.contains("tara")&&(t+=1),e.classList.contains("atitara")&&(t+=2);const l=swaraFreq(a,t),h=n-s;if(l){const e=playTone(l,u+h*i,i);c.push(e)}r.push(setTimeout(()=>{o.forEach(e=>e.classList.remove("playing")),e.classList.add("playing")},h*i*1e3))}r.push(setTimeout(()=>{stopPlayer(n,t)},(o.length-s)*i*1e3)),activePlayers[n]={timers:r,oscillators:c},t.classList.add("playing"),t.innerText="■ நிறுத்து",addProgress(e,(o.length-s)*i*1e3)}function startPlayer(e,t,n){e.querySelectorAll(".anga-group").forEach(s=>{s.style.cursor="pointer",s.addEventListener("click",function(){const o=Array.from(e.querySelectorAll(".swara-cell")),i=s.querySelector(".swara-cell"),a=o.indexOf(i);startFromIndex(e,t,n,a)})});const s=Array.from(e.querySelectorAll(".swara-cell"));if(!s.length)return;const r=parseInt(e.dataset.bpm)||72,o=60/r,c=parseInt(e.dataset.octave)||4,l=getAudio(),d=l.currentTime+.05,i=[],a=[];s.forEach((e,t)=>{const u=e.innerText.trim(),r=TAMIL_MAP[u];if(!r)return;let n=c-4;e.classList.contains("mandra")&&(n-=1),e.classList.contains("anumandra")&&(n-=2),e.classList.contains("tara")&&(n+=1),e.classList.contains("atitara")&&(n+=2);const l=swaraFreq(r,n);if(l){const e=playTone(l,d+t*o,o);a.push(e)}i.push(setTimeout(()=>{s.forEach(e=>e.classList.remove("playing")),e.classList.add("playing")},t*o*1e3))}),i.push(setTimeout(()=>{stopPlayer(n,t)},s.length*o*1e3)),activePlayers[n]={timers:i,oscillators:a},t.classList.add("playing"),t.innerText="■ நிறுத்து",addProgress(e,s.length*o*1e3)}function stopPlayer(e,t){if(!activePlayers[e])return;const n=activePlayers[e];if(!n)return;n.timers.forEach(clearTimeout),n.oscillators.forEach(e=>{try{e.stop()}catch{}}),delete activePlayers[e];const s=t?t.closest(".swara-block"):document.querySelector(`[data-player-id="${e}"]`);if(!s)return;s.querySelectorAll(".swara-cell").forEach(e=>e.classList.remove("playing")),t&&(t.classList.remove("playing"),t.innerText="▶ இசை"),resetProgress(s)}window.adjustBpm=function(e,t){const s=e.closest(".swara-block");let n=parseInt(s.dataset.bpm)||72;n=Math.max(20,Math.min(300,n+t)),s.dataset.bpm=n,s.querySelector(".bpm-display").innerText=n};function addProgress(e,t){let n=e.querySelector(".swara-progress-bar");if(!n){n=document.createElement("div"),n.className="swara-progress-bar";const t=document.createElement("div");t.className="swara-progress-fill",n.appendChild(t),e.appendChild(n)}const s=n.querySelector(".swara-progress-fill");s.style.transition="none",s.style.width="0%",s.offsetWidth,s.style.transition=`width ${t/1e3}s linear`,s.style.width="100%"}function resetProgress(e){const t=e.querySelector(".swara-progress-fill");t&&(t.style.width="0%")}