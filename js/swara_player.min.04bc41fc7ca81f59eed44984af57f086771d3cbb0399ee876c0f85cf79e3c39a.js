const SWARASTHANA={S:0,R1:1,R2:2,G1:2,R3:3,G2:3,G3:4,M1:5,M2:6,P:7,D1:8,D2:9,N1:9,D3:10,N2:10,N3:11};function tamilToSwarasthana(e,t){const n=t.dataset.r,s=t.dataset.g,o=t.dataset.m,i=t.dataset.d,a=t.dataset.n,r={"ச":"S","ரி":n,"க":s,"ம":o,"ப":"P","த":i,"நி":a,"ரி1":"R1","ரி2":"R2","ரி3":"R3","க1":"G1","க2":"G2","க3":"G3","ம1":"M1","ம2":"M2","த1":"D1","த2":"D2","த3":"D3","நி1":"N1","நி2":"N2","நி3":"N3"};return r[e]||null}let piano,pianoReady=!1,currentTimeouts=[];async function initPiano(){piano=new Tone.Sampler({urls:{A1:"A1.mp3",C2:"C2.mp3","D#2":"Ds2.mp3","F#2":"Fs2.mp3",A2:"A2.mp3",C3:"C3.mp3","D#3":"Ds3.mp3","F#3":"Fs3.mp3",A3:"A3.mp3",C4:"C4.mp3","D#4":"Ds4.mp3","F#4":"Fs4.mp3",A4:"A4.mp3",C5:"C5.mp3","D#5":"Ds5.mp3","F#5":"Fs5.mp3",A5:"A5.mp3",C6:"C6.mp3"},baseUrl:"https://tonejs.github.io/audio/salamander/"}).toDestination(),await Tone.loaded(),pianoReady=!0}initPiano(),window.toggleSwaraPlay=async function(e){const t=e.closest(".swara-block");if(e.classList.contains("playing")){stopPlayback(e);return}await Tone.start(),pianoReady||await Tone.loaded(),startPlayback(t,e)};function swaraToPianoNote(e,t=4){const n=SWARASTHANA[e];if(n===0[0])return null;const s=12*(t+1),o=s+n;return Tone.Frequency(o,"midi").toNote()}function startPlayback(e,t){const n=Array.from(e.querySelectorAll(".swara-cell"));if(!n.length)return;const o=parseInt(e.dataset.bpm)||72,s=60/o,i=parseInt(e.dataset.octave)||4;t.classList.add("playing"),t.innerText="■ நிறுத்து",n.forEach((t,o)=>{const l=t.textContent.replace(/\s+/g,"").trim(),r=tamilToSwarasthana(l,e);if(!r)return;let a=0;t.classList.contains("mandra")&&(a=-1),t.classList.contains("anumandra")&&(a=-2),t.classList.contains("tara")&&(a=1),t.classList.contains("atitara")&&(a=2);const c=swaraToPianoNote(r,i+a);if(!c)return;const d=o*s*1e3,u=setTimeout(()=>{n.forEach(e=>e.classList.remove("playing")),t.classList.add("playing"),piano.triggerAttackRelease(c,s)},d);currentTimeouts.push(u)});const a=setTimeout(()=>{stopPlayback(t)},n.length*s*1e3);currentTimeouts.push(a)}function stopPlayback(e){currentTimeouts.forEach(clearTimeout),currentTimeouts=[],document.querySelectorAll(".swara-cell").forEach(e=>e.classList.remove("playing")),e.classList.remove("playing"),e.innerText="▶ இசை"}window.adjustBpm=function(e,t){const s=e.closest(".swara-block");let n=parseInt(s.dataset.bpm)||72;n=Math.max(20,Math.min(300,n+t)),s.dataset.bpm=n;const o=s.querySelector(".bpm-display");o&&(o.innerText=n)},document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".swara-block").forEach(e=>{const t=e.querySelector(".swara-play-btn");e.querySelectorAll(".anga-group").forEach(n=>{n.style.cursor="pointer",n.addEventListener("click",async()=>{await Tone.start(),stopPlayback(t);const o=Array.from(e.querySelectorAll(".swara-cell")),i=n.querySelector(".swara-cell"),s=o.indexOf(i);if(s===-1)return;startPlaybackFromIndex(e,t,s)})})})})